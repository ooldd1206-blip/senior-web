datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  passwordHash   String?  @default("")   // å…è¨± null or ç©ºå­—ä¸²
  displayName    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  emailVerifiedAt          DateTime?
  verificationToken        String?   @unique
  verificationTokenExpires DateTime?
  resetToken               String?   @unique
  resetTokenExpires        DateTime?

  isOnboarded Boolean @default(false)
  onboardingCompleted Boolean @default(false)   

  // é…å°
  likesGiven     Match[]        @relation("Liker")
  likesReceived  Match[]        @relation("Liked")

  joinedActivities ActivityJoin[]
  activitiesCreated Activity[]  @relation("CreatedActivities")

  sentMessages     Message[]    @relation("SentMessages")
  receivedMessages Message[]    @relation("ReceivedMessages")

  gender       String?
  ageGroup     String?
  city         String?
  interests    String?
  bio          String?
  avatarUrl    String?
  galleryUrls  String[] @default([])
  chatsA Chat[] @relation("ChatUserA")
  chatsB Chat[] @relation("ChatUserB")
}


model Activity {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime
  location    String?
  category    String
  capacity    Int?
  createdAt   DateTime @default(now())

  // ğŸ†• å»ºç«‹è€…
  creatorId   String
  creator     User     @relation("CreatedActivities", fields: [creatorId], references: [id])

  // ğŸ†• ä¸»è¾¦äººè¯çµ¡é›»è©±ï¼ˆå ±åè€…åœ¨æ´»å‹•è©³æƒ…æœƒçœ‹åˆ°ï¼‰
  contactPhone String?

  participants ActivityJoin[]
}


model ActivityJoin {
  id         String   @id @default(cuid())
  userId     String
  activityId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  activity Activity @relation(fields: [activityId], references: [id])
}

model Match {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  likerId   String
  likedId   String
  isMutual  Boolean  @default(false)

  liker User @relation("Liker", fields: [likerId], references: [id])
  liked User @relation("Liked", fields: [likedId], references: [id])

  @@unique([likerId, likedId])
  @@index([likerId])
  @@index([likedId])
}

enum ChatSource {
  MATCH          // äº¤å‹é…å°ä¾†çš„
  ACTIVITY_CARD  // æ´»å‹•ï¼šæ‰¾ç‰Œå’–
  ACTIVITY_TRIP  // æ´»å‹•ï¼šæ‰¾æ—…ä¼´/ç©ä¼´
}

model Message {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  content     String
  senderId    String
  receiverId  String
  read        Boolean  @default(false)

  source      ChatSource?

  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

model Chat {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // é›™æ–¹ä½¿ç”¨è€…
  userA     String
  userB     String

  source    ChatSource?  // MATCH / ACTIVITY_CARD / ACTIVITY_TRIP  
  lastMessage String?
  lastTime    DateTime? @default(now())

  // Prisma é—œè¯
  UserA User @relation("ChatUserA", fields: [userA], references: [id])
  UserB User @relation("ChatUserB", fields: [userB], references: [id])

  @@unique([userA, userB]) // é˜²æ­¢é‡è¤‡èŠå¤©å®¤
}
